name: Create Release Draft

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.2.3)'
        required: true
        type: string

permissions:
  contents: write

defaults:
  run:
    working-directory: cli

jobs:
  create-draft-release:
    name: Create Draft Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Validate version format
      run: |
        if ! echo "${{ inputs.version }}" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
          echo "Error: Version must be in format X.Y.Z (e.g., 1.2.3)"
          exit 1
        fi

    - name: Check if tag exists
      run: |
        if git rev-parse "azd-app-cli-v${{ inputs.version }}" >/dev/null 2>&1; then
          echo "Error: Tag azd-app-cli-v${{ inputs.version }} already exists"
          exit 1
        fi

    - name: Update version file
      run: |
        echo "${{ inputs.version }}" > version.txt
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add version.txt
        git commit -m "chore: bump version to ${{ inputs.version }}"
        git push

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
        cache-dependency-path: cli/go.sum

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: cli/dashboard/package.json

    - name: Build dashboard
      run: |
        cd dashboard
        npm install
        npm run build
        cd ..

    - name: Build for all platforms
      run: |
        BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        LDFLAGS="-s -w -X github.com/jongio/azd-app/cli/src/cmd/app/commands.Version=${{ inputs.version }} -X github.com/jongio/azd-app/cli/src/cmd/app/commands.BuildTime=$BUILD_TIME"
        
        # Windows AMD64
        GOOS=windows GOARCH=amd64 go build -ldflags="$LDFLAGS" -o bin/windows-amd64/app.exe ./src/cmd/app
        
        # Linux AMD64
        GOOS=linux GOARCH=amd64 go build -ldflags="$LDFLAGS" -o bin/linux-amd64/app ./src/cmd/app
        
        # macOS AMD64
        GOOS=darwin GOARCH=amd64 go build -ldflags="$LDFLAGS" -o bin/darwin-amd64/app ./src/cmd/app
        
        # macOS ARM64
        GOOS=darwin GOARCH=arm64 go build -ldflags="$LDFLAGS" -o bin/darwin-arm64/app ./src/cmd/app

    - name: Create platform packages
      run: |
        # Copy extension.yaml to each platform directory
        for dir in bin/*/; do
          cp extension.yaml "$dir"
        done
        
        # Create zip for Windows
        cd bin/windows-amd64
        zip -r ../../app-windows-amd64.zip .
        cd ../..
        
        # Create tar.gz for Linux
        cd bin/linux-amd64
        tar -czf ../../app-linux-amd64.tar.gz .
        cd ../..
        
        # Create tar.gz for macOS AMD64
        cd bin/darwin-amd64
        tar -czf ../../app-darwin-amd64.tar.gz .
        cd ../..
        
        # Create tar.gz for macOS ARM64
        cd bin/darwin-arm64
        tar -czf ../../app-darwin-arm64.tar.gz .
        cd ../..

    - name: Calculate checksums
      id: checksums
      run: |
        mkdir -p ../release-assets
        
        echo "## Checksums" > ../release-assets/checksums.txt
        echo "" >> ../release-assets/checksums.txt
        
        sha256sum app-windows-amd64.zip | tee -a ../release-assets/checksums.txt
        sha256sum app-linux-amd64.tar.gz | tee -a ../release-assets/checksums.txt
        sha256sum app-darwin-amd64.tar.gz | tee -a ../release-assets/checksums.txt
        sha256sum app-darwin-arm64.tar.gz | tee -a ../release-assets/checksums.txt
        
        # Extract individual checksums for registry update
        WIN_SHA=$(sha256sum app-windows-amd64.zip | awk '{print $1}')
        LINUX_SHA=$(sha256sum app-linux-amd64.tar.gz | awk '{print $1}')
        DARWIN_AMD64_SHA=$(sha256sum app-darwin-amd64.tar.gz | awk '{print $1}')
        DARWIN_ARM64_SHA=$(sha256sum app-darwin-arm64.tar.gz | awk '{print $1}')
        
        echo "WIN_SHA=$WIN_SHA" >> $GITHUB_OUTPUT
        echo "LINUX_SHA=$LINUX_SHA" >> $GITHUB_OUTPUT
        echo "DARWIN_AMD64_SHA=$DARWIN_AMD64_SHA" >> $GITHUB_OUTPUT
        echo "DARWIN_ARM64_SHA=$DARWIN_ARM64_SHA" >> $GITHUB_OUTPUT

    - name: Update registry.json with checksums
      run: |
        VERSION="${{ inputs.version }}"
        
        # Update the registry.json in repo root with actual version and checksums
        cd ..
        jq --arg version "$VERSION" \
           --arg win "${{ steps.checksums.outputs.WIN_SHA }}" \
           --arg linux "${{ steps.checksums.outputs.LINUX_SHA }}" \
           --arg darwin_amd64 "${{ steps.checksums.outputs.DARWIN_AMD64_SHA }}" \
           --arg darwin_arm64 "${{ steps.checksums.outputs.DARWIN_ARM64_SHA }}" \
           '.extensions[0].versions[0].version = $version |
            .extensions[0].versions[0].artifacts["windows/amd64"].url = "https://github.com/jongio/azd-app/releases/download/azd-app-cli-v\($version)/app-windows-amd64.zip" |
            .extensions[0].versions[0].artifacts["windows/amd64"].checksum.value = $win |
            .extensions[0].versions[0].artifacts["linux/amd64"].url = "https://github.com/jongio/azd-app/releases/download/azd-app-cli-v\($version)/app-linux-amd64.tar.gz" |
            .extensions[0].versions[0].artifacts["linux/amd64"].checksum.value = $linux |
            .extensions[0].versions[0].artifacts["darwin/amd64"].url = "https://github.com/jongio/azd-app/releases/download/azd-app-cli-v\($version)/app-darwin-amd64.tar.gz" |
            .extensions[0].versions[0].artifacts["darwin/amd64"].checksum.value = $darwin_amd64 |
            .extensions[0].versions[0].artifacts["darwin/arm64"].url = "https://github.com/jongio/azd-app/releases/download/azd-app-cli-v\($version)/app-darwin-arm64.tar.gz" |
            .extensions[0].versions[0].artifacts["darwin/arm64"].checksum.value = $darwin_arm64' \
           registry.json > registry.tmp.json && mv registry.tmp.json registry.json
        
        # Copy updated registry.json to release assets
        mkdir -p release-assets
        cp registry.json release-assets/registry.json

    - name: Extract changelog for this version
      id: changelog
      run: |
        VERSION="${{ inputs.version }}"
        # Extract changelog section for this version
        if [ -f CHANGELOG.md ]; then
          sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d' > ../release-assets/release-notes.md || echo "Release $VERSION" > ../release-assets/release-notes.md
        else
          echo "# Release $VERSION" > ../release-assets/release-notes.md
          echo "" >> ../release-assets/release-notes.md
          echo "## What's Changed" >> ../release-assets/release-notes.md
          echo "" >> ../release-assets/release-notes.md
          echo "See commit history for details." >> ../release-assets/release-notes.md
        fi
        echo "" >> ../release-assets/release-notes.md
        cat ../release-assets/checksums.txt >> ../release-assets/release-notes.md

    - name: Commit registry.json update
      run: |
        cd ..
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add registry.json
        git commit -m "chore: update registry.json for version ${{ inputs.version }}"
        git push

    - name: Create Git tag
      run: |
        git tag "azd-app-cli-v${{ inputs.version }}" -m "Release version ${{ inputs.version }}"
        git push origin "azd-app-cli-v${{ inputs.version }}"

    - name: Create Draft GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: azd-app-cli-v${{ inputs.version }}
        name: CLI v${{ inputs.version }}
        body_path: release-assets/release-notes.md
        files: |
          cli/app-windows-amd64.zip
          cli/app-linux-amd64.tar.gz
          cli/app-darwin-amd64.tar.gz
          cli/app-darwin-arm64.tar.gz
          release-assets/registry.json
          release-assets/checksums.txt
        draft: true
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Summary
      run: |
        echo "âœ… Draft release created for version ${{ inputs.version }}"
        echo ""
        echo "Next steps:"
        echo "1. Go to https://github.com/${{ github.repository }}/releases"
        echo "2. Review the draft release"
        echo "3. Click 'Publish release' when ready"
        echo ""
        echo "Tag created: azd-app-cli-v${{ inputs.version }}"
