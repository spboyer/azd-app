name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      release-type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Get current version
        id: current
        run: |
          VERSION=$(jq -r '.cli' .release-please-manifest.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Calculate next version
        id: next
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          IFS='.' read -r major minor patch <<< "$CURRENT"
          
          case "${{ inputs.release-type }}" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac
          
          NEXT="$major.$minor.$patch"
          echo "version=$NEXT" >> $GITHUB_OUTPUT
      
      - name: Update version files
        run: |
          VERSION="${{ steps.next.outputs.version }}"
          
          # Update manifest
          jq --arg v "$VERSION" '.cli = $v' .release-please-manifest.json > tmp.json
          mv tmp.json .release-please-manifest.json
          
          # Update extension.yaml
          cd cli
          sed -i "s/^version: .*/version: $VERSION/" extension.yaml
      
      - name: Generate changelog
        run: |
          VERSION="${{ steps.next.outputs.version }}"
          PREV="${{ steps.current.outputs.version }}"
          
          cd cli
          
          # Get commits since last release
          COMMITS=$(git log v${PREV}..HEAD --pretty=format:"- %s (%h)" --no-merges 2>/dev/null || git log --pretty=format:"- %s (%h)" --no-merges -n 20)
          
          # Create new changelog entry
          DATE=$(date +%Y-%m-%d)
          {
            echo "## [$VERSION] - $DATE"
            echo ""
            echo "$COMMITS"
            echo ""
            cat CHANGELOG.md
          } > CHANGELOG.new.md
          mv CHANGELOG.new.md CHANGELOG.md
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          commit-message: "Prepare release v${{ steps.next.outputs.version }}"
          title: "Prepare release v${{ steps.next.outputs.version }}"
          body: |
            ## Release v${{ steps.next.outputs.version }}
            
            **Current version:** v${{ steps.current.outputs.version }}  
            **New version:** v${{ steps.next.outputs.version }}  
            **Release type:** ${{ inputs.release-type }}
            
            This PR updates:
            - Version in `cli/extension.yaml`
            - `cli/CHANGELOG.md`
            - `.release-please-manifest.json`
            
            ### Next Steps
            1. Review the changes
            2. Merge this PR
            3. Run the **Release** workflow with version `${{ steps.next.outputs.version }}`
          branch: release/v${{ steps.next.outputs.version }}
          delete-branch: true
